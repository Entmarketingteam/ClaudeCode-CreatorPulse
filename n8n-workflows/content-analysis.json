{
  "name": "Creator Pulse - Content Analysis Pipeline",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "content-added",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "New Content Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [250, 300],
      "webhookId": "content-analysis-webhook"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.body.content_id }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "validate-input",
      "name": "Validate Input",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [470, 300]
    },
    {
      "parameters": {
        "url": "={{ $env.SUPABASE_URL }}/rest/v1/content_master?id=eq.{{ $json.body.content_id }}&select=*",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth"
      },
      "id": "get-content",
      "name": "Get Content Details",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [690, 200],
      "credentials": {
        "httpHeaderAuth": {
          "id": "supabase-auth",
          "name": "Supabase Auth"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json[0].is_analyzed }}",
              "value2": false
            }
          ]
        }
      },
      "id": "check-not-analyzed",
      "name": "Not Already Analyzed?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [910, 200]
    },
    {
      "parameters": {
        "url": "={{ $env.API_URL }}/analyze/content",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"content_id\": \"{{ $json[0].id }}\"\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "trigger-analysis",
      "name": "Trigger AI Analysis",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1130, 200],
      "credentials": {
        "httpHeaderAuth": {
          "id": "api-key-auth",
          "name": "API Key Auth"
        }
      }
    },
    {
      "parameters": {
        "value": 30000
      },
      "id": "wait-for-analysis",
      "name": "Wait for Analysis (30s)",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [1350, 200]
    },
    {
      "parameters": {
        "url": "={{ $env.SUPABASE_URL }}/rest/v1/creative_attributes?content_id=eq.{{ $json.content_id }}&select=*",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth"
      },
      "id": "get-analysis-results",
      "name": "Get Analysis Results",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1570, 200],
      "credentials": {
        "httpHeaderAuth": {
          "id": "supabase-auth",
          "name": "Supabase Auth"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.length }}",
              "operation": "larger",
              "value2": 0
            }
          ]
        }
      },
      "id": "check-results",
      "name": "Analysis Successful?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1790, 200]
    },
    {
      "parameters": {
        "url": "={{ $env.API_URL }}/attribution/run?user_id={{ $json[0].user_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "method": "POST"
      },
      "id": "trigger-attribution",
      "name": "Trigger Attribution",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2010, 100],
      "credentials": {
        "httpHeaderAuth": {
          "id": "api-key-auth",
          "name": "API Key Auth"
        }
      }
    },
    {
      "parameters": {
        "channel": "#creator-pulse-alerts",
        "text": "=Analysis failed for content {{ $json.content_id }}",
        "otherOptions": {}
      },
      "id": "alert-analysis-failure",
      "name": "Alert Analysis Failure",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.1,
      "position": [2010, 300],
      "credentials": {
        "slackApi": {
          "id": "slack-api",
          "name": "Slack API"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": false,\n  \"error\": \"Invalid input - content_id required\"\n}"
      },
      "id": "respond-error",
      "name": "Respond with Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [690, 400]
    }
  ],
  "connections": {
    "New Content Webhook": {
      "main": [
        [
          {
            "node": "Validate Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Input": {
      "main": [
        [
          {
            "node": "Get Content Details",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond with Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Content Details": {
      "main": [
        [
          {
            "node": "Not Already Analyzed?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Not Already Analyzed?": {
      "main": [
        [
          {
            "node": "Trigger AI Analysis",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Trigger AI Analysis": {
      "main": [
        [
          {
            "node": "Wait for Analysis (30s)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait for Analysis (30s)": {
      "main": [
        [
          {
            "node": "Get Analysis Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Analysis Results": {
      "main": [
        [
          {
            "node": "Analysis Successful?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analysis Successful?": {
      "main": [
        [
          {
            "node": "Trigger Attribution",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Alert Analysis Failure",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true
  }
}
